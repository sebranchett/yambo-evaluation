# Getting Quantum Espresso and Yambo to work for evaluation purposes

## DelftBlue
DelftBlue instructions [here](https://doc.dhpc.tudelft.nl/delftblue/crash-course/).

### Quantum Espresso
Quantum Espresso installation instructions [here](https://www.quantum-espresso.org/Doc/user_guide/user_guide.html). Version 7.3.1.

I downloaded the 7.3.1 zip from [here](https://gitlab.com/QEF/q-e/-/releases/), but it would be better to register and download.

This script unzips `q-e-qe-7.3.1.tar.gz` as a batch job:
```
qe-tar-script.sh
```
The unzipped git repository contains sub-modules that need to be initialised. This step could possibly be avoided by registering and downloading as intended.
```
cd ./q-e-qe-7.3.1/external
./initialize_external_repos.sh  # needs internet
cd ../..
```
Then run these scripts:
```
qe-config-script.sh  # to configure the installation
qe-make-script.sh  # to compile the code
qe-test-script.sh  # to run the tests
qe-example-script.sh  # to run the examples
```
> [!NOTE]
> If you want to run the examples in parallel, you need to edit the file: `q-e-qe-7.3.1/environment_variables` and change the lines defining `PARA_PREFIX` and `PARA_POSTFIX`:
>
> `PARA_PREFIX="srun"`
>
> `PARA_POSTFIX=""`

### Yambo
Yambo installation instructions [here](https://www.yambo-code.eu/wiki/index.php/Installation). You can download the software [here](https://github.com/yambo-code/yambo/wiki/Releases-%28tar.gz-format%29). Version tested: 5.2.3.

Run 6 scripts:
```
tar-script.sh  # to extract Yambo from yambo-5.2.3.tar.gz
config-script.sh  # to configure installation (with DelftBlue HDF5 and NetCDF)
make-script.sh  # to compile Yambo and supporting tools (with DelftBlue HDF5 and NetCDF)
config-script-continued.sh  # to configure installation (with Yambo HDF5 and NetCDF)
make-script-continued.sh  # to compile Yambo and supporting tools (with Yambo HDF5 and NetCDF)
check-script.sh  # to check Yambo has been installed
```
> [!NOTE]
> The file `yambo-5.2.3/config/setup`, generated by `config-script.sh`, contains extra line endings `\n\n` in 2 places around the `hdf5` libraries. These must be removed, by hand, before `make` will run.

> [!NOTE]
> yambo-5.2.3 has problems with libxc-5.2.3. Solved this by editing file `yambo-5.2.3/lib/archive/package.list` and replacing `url_libxc=https://www.tddft.org/programs/libxc/down/$(version_libxc)/$(tarball_libxc)` with `url_libxc=https://www.cp2k.org/static/downloads/$(tarball_libxc)`. Looking at the yambo GitHub repository, this problem has already been solved for future versions (by downloading from https://gitlab.com/libxc).

> [!NOTE]
> The configuration and making of Yambo takes place in two parts here.
> Dipole calculation does not work in parallel with the DelftBlue version of HDF5 and NetCDF, so the Yambo downloaded versions of these libraries are used.
> Configuring and making Yambo with it's own versions of HDF5 and NetCDF from the start failed, due to insufficient space.

As explained in the Yambo installation instructions, successful output includes:
```
Cannot access CORE database (SAVE/*db1 and/or SAVE/*wf)
```

## Windows laptop with Docker

### Yambo

### Tried...
```
tar zxfv yambo-5.1.2.tar.gz
rm yambo-5.1.2.tar.gz
```
... on vanilla linux, but too much work. Need to install compilers, etc.

### Tried...
```
docker pull maxcentre/yambo:5.1.1_gcc9
docker run --rm -it -v //c/Users/sbranchett/work/yambo/data:/home/yambo maxcentre/yambo:5.1.1_gcc9
```
...but then I don't have Quantum Espresso and I can't install it as I am a non-root user.

### Tried...
```
FROM continuumio/anaconda3

RUN conda install qe --channel conda-forge
RUN conda install yambo --channel conda-forge
```
...but after 16000 seconds, it still couldn't resolve the environment for the last command.

### Settled on...
Dockerfile in this repo, which uses `apt` to install Quantum Espresso, then installs Conda and then uses Conda to install Yambo.

Good enough for evaluation purposes.

### Useful commands
To build the Docker image:
```
docker build . -t yambo
```
To run a Docker container:
```
docker run --rm -it -e DISPLAY=$DISPLAY -v //c/Users/sbranchett/work/yambo/data:/home/yambo yambo
```
The $DISPLAY environment variable is to get gnuplot working properly.

Before running a Docker container from a Windows machine, use `ipconfig` to find its ip, and then add an ':0'.
```
export DISPLAY="192.168.99.1:0"
```
Also, change the Xming shortcut to run:
```
"C:\Program Files (x86)\Xming\Xming.exe" :0 -clipboard -multiwindow -ac
```
The "-ac" is important!
```
apt install -y x11-apps 
```
...has `xeyes` for testing.
